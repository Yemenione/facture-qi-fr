// schema.prisma

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --------------------------------------
// SUPER ADMIN & PLATFORM MANAGEMENT
// --------------------------------------

model SuperAdmin {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  password  String   // Hashed (Argon2)
  name      String?
  createdAt DateTime @default(now())
}

model SubscriptionPlan {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  code           String    @unique // ex: 'FREE', 'PRO', 'AGENCY'
  name           String
  priceMonthly   Int       // Using Int for cents or simple handling, or Float. Decimal is supported but requires care.
  maxInvoices    Int       // -1 for unlimited
  maxUsers       Int       // -1 for unlimited
  features       Json      // Feature flags like { "api_access": true, "custom_branding": false }
  companies      Company[]
}

// --------------------------------------
// TENANTS (ENTREPRISES CLIENTES)
// --------------------------------------

model Company {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  siren           String   @unique // French Business ID
  siret           String?  // SIRET (14 digits)
  vatNumber       String?  // TVA Intracommunautaire
  vatSystem       String?  // 'FRANCHISE', 'REAL_NORMAL', 'REAL_SIMPLIFIED'
  email           String?
  phone           String?
  address         Json     // { street, city, zip, country }
  logoUrl         String?
  
  // Subscription related
  planId          String   @db.ObjectId
  plan            SubscriptionPlan @relation(fields: [planId], references: [id])
  subscriptionStatus String // 'ACTIVE', 'PAST_DUE', 'CANCELLED'
  stripeCustomerId   String?

  // Settings
  legalMentions   String?  // Mention légale par défaut bas de page
  facturXProfile  String   @default("BASIC") // BASIC, EN_16931, EXTENDED
  
  // Mandatory Legal Mentions 2026
  capital         String?  // Capital social (ex: "1000")
  rcs             String?  // Ville d'immatriculation (ex: "Paris")
  iban            String?
  bic             String?
  penalties       String?  // Taux de pénalités (ex: "3 fois le taux d'intérêt légal")

  // Extended Company Data (Legal/Activity)
  legalForm       String?  // e.g. "Entrepreneur individuel", "SARL"...
  nafCode         String?  // e.g. "53.20Z"
  activityLabel   String?  // e.g. "Autres activités de poste et de courrier"
  managerName     String?  // e.g. "Jean Dupont"
  rcsNumber       String?  // Inscription
  creationDate    DateTime? // Date de création
  category        String?  // PME, ETI...
  
  // Relations
  users           User[]
  clients         Client[]
  invoices        Invoice[]
  products        Product[]
  templates       InvoiceTemplate[]
  settings        CompanySettings?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// --------------------------------------
// USERS (WITHIN COMPANIES)
// --------------------------------------

enum UserRole {
  OWNER
  ADMIN
  ACCOUNTANT // Read-only + Exports
  SALES      // Can create drafts only
}

model User {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  email       String   @unique
  password    String
  firstName   String
  lastName    String
  role        UserRole @default(ADMIN)
  
  companyId   String   @db.ObjectId
  company     Company  @relation(fields: [companyId], references: [id])
  
  createdAt   DateTime @default(now())
}

// --------------------------------------
// CRM & CATALOG
// --------------------------------------

model Client {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   
  isBusiness  Boolean  @default(true)
  siren       String?
  siret       String?
  legalForm   String?
  nafCode     String?
  vatSystem   String?
  vatNumber   String?
  email       String
  phone       String?
  address     Json     // { billing: {...}, delivery: {...} }
  
  companyId   String   @db.ObjectId
  company     Company  @relation(fields: [companyId], references: [id])
  invoices    Invoice[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Product {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  price       Float    // Decimal is tricky in Mongo, using Float for simplicity or Int (cents) is often easier. Let's stick to Float/Int or keep Decimal if mapped correctly.
  vatRate     Float
  unit        String   @default("piece") // jour, heure, forfait, etc.
  
  companyId   String   @db.ObjectId
  company     Company  @relation(fields: [companyId], references: [id])
}

// --------------------------------------
// INVOICING CORE (COMPLIANCE CRITICAL)
// --------------------------------------

enum InvoiceStatus {
  DRAFT       // Modifiable
  VALIDATED   // Scellé, envoyé au client (Immutable)
  PARTIALLY_PAID
  PAID
  OVERDUE     // En retard
  CANCELLED   // Annulé
}

enum DocumentType {
  INVOICE
  QUOTE       // Devis
  CREDIT_NOTE // Avoir
}

model Invoice {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  
  // Chrono Sequence (Must be unique per Company + Year)
  seqNumber       Int?           // 1, 2, 3... (Optional for Drafts)
  invoiceNumber   String         @unique // "2026-F001"
  
  type            DocumentType   @default(INVOICE)
  status          InvoiceStatus  @default(DRAFT)
  
  issueDate       DateTime       @default(now())
  dueDate         DateTime?
  validityDate    DateTime?      // Pour les Devis (Valid until)
  validationDate  DateTime?      // Date de validation finale (Factur-X)
  
  // Compliance / Security
  pdfUrl          String?
  securityHash    String?
  previousHash    String?
  
  // Financials
  subTotal        Float
  taxAmount       Float
  total           Float
  
  notes           String?
  terms           String?        // Conditions spécifiques
  
  // Relations
  clientId        String         @db.ObjectId
  client          Client         @relation(fields: [clientId], references: [id])
  
  companyId       String         @db.ObjectId
  company         Company        @relation(fields: [companyId], references: [id])
  
  items           InvoiceItem[]
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  @@index([companyId])
  @@index([clientId])
  @@unique([companyId, invoiceNumber])
}

model InvoiceItem {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String
  quantity    Float
  unitPrice   Float
  vatRate     Float
  total       Float
  
  invoiceId   String   @db.ObjectId
  invoice     Invoice  @relation(fields: [invoiceId], references: [id])
}

// --------------------------------------
// INVOICE TEMPLATES & CUSTOMIZATION
// --------------------------------------

enum TemplateType {
  CLASSIC
  MODERN
  ELEGANT
  COLORFUL
}

enum LogoPosition {
  LEFT
  CENTER
  RIGHT
}

enum HeaderStyle {
  MINIMAL
  DETAILED
  BANNER
}

model InvoiceTemplate {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  name        String       // "Mon template bleu", "Template entreprise"
  type        TemplateType @default(CLASSIC)
  isDefault   Boolean      @default(false)
  
  // Customization - Colors
  primaryColor     String @default("#4F46E5")    // Indigo
  secondaryColor   String @default("#818CF8")    // Light Indigo
  textColor        String @default("#1F2937")    // Gray-800
  backgroundColor  String @default("#FFFFFF")    // White
  
  // Logo
  logoUrl          String?
  logoPosition     LogoPosition @default(LEFT)
  logoWidth        Int          @default(150)   // pixels
  
  // Typography
  fontFamily       String @default("Inter")
  headerFontSize   Int    @default(24)
  bodyFontSize     Int    @default(14)
  
  // Layout
  headerStyle      HeaderStyle @default(DETAILED)
  showFooter       Boolean     @default(true)
  footerText       String?
  
  // Legal & Payment
  legalMentions    String?
  paymentTermsText String?
  
  // Relations
  companyId   String  @db.ObjectId
  company     Company @relation(fields: [companyId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([companyId])
}

// Company Settings for Legal Compliance
model CompanySettings {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Legal Information (Required for French invoices)
  legalName   String   // Nom légal complet
  legalForm   String   // SARL, SAS, EURL, EI, etc.
  siret       String   @unique
  vatNumber   String?  // TVA Intracommunautaire
  
  // Address
  address     String
  postalCode  String
  city        String
  country     String   @default("France")
  
  // Contact
  email       String
  phone       String
  website     String?
  
  // Banking (for invoice payment)
  iban        String?
  bic         String?
  bankName    String?
  
  // Legal Details
  capital     Float?   // Capital social
  rcs         String?  // RCS Paris B 123 456 789
  insurance   String?  // Assurance professionnelle
  
  // Professional Details
  nafCode     String?  // Code APE/NAF
  tvaSystem   String?  // FRANCHISE, NORMAL, SIMPLIFIE
  
  // Default Settings
  defaultPaymentTerms String @default("Paiement à 30 jours")
  defaultLegalMention String?
  defaultPenaltyRate  String @default("3 fois le taux d'intérêt légal")
  
  // Relations
  companyId   String   @unique @db.ObjectId
  company     Company  @relation(fields: [companyId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

