// schema.prisma

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --------------------------------------
// SUPER ADMIN & PLATFORM MANAGEMENT
// --------------------------------------

model SuperAdmin {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  password  String   // Hashed (Argon2)
  name      String?
  createdAt DateTime @default(now())
}

model MarketingCampaign {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  subject   String
  content   String
  segment   String   // 'ALL', 'ACTIVE', 'INACTIVE', 'PRO_PLAN'
  status    String   // 'DRAFT', 'SENT', 'SCHEDULED'
  sentAt    DateTime?
  sentCount Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SubscriptionPlan {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  code           String    @unique // ex: 'FREE', 'PRO', 'AGENCY'
  name           String
  priceMonthly   Int       // Using Int for cents or simple handling, or Float. Decimal is supported but requires care.
  maxInvoices    Int       // -1 for unlimited
  maxUsers       Int       // -1 for unlimited
  features       Json      // Feature flags like { "api_access": true, "custom_branding": false }
  companies      Company[]
}

// --------------------------------------
// ENUMS
// --------------------------------------

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

// --------------------------------------
// TENANTS (ENTREPRISES CLIENTES)
// --------------------------------------

model Company {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  siren           String   @unique // French Business ID
  siret           String?  // SIRET (14 digits)
  vatNumber       String?  // TVA Intracommunautaire
  vatSystem       String?  // 'FRANCHISE', 'REAL_NORMAL', 'REAL_SIMPLIFIED'
  email           String?
  phone           String?
  address         Json     // { street, city, zip, country }
  logoUrl         String?
  
  // Subscription related
  planId          String   @db.ObjectId
  plan            SubscriptionPlan @relation(fields: [planId], references: [id])
  subscriptionStatus String // 'ACTIVE', 'PAST_DUE', 'CANCELLED'
  stripeCustomerId   String?
  features           Json?    // Custom feature overrides { "api_access": true }

  // Settings
  legalMentions   String?  // Mention légale par défaut bas de page
  facturXProfile  String   @default("BASIC") // BASIC, EN_16931, EXTENDED
  
  // KYC / Verification
  verificationStatus VerificationStatus @default(PENDING)
  verificationDocuments Json? // [{ type: 'KBIS', url: '...' }, { type: 'ID', url: '...' }]
  
  // Mandatory Legal Mentions 2026
  capital         String?  // Capital social (ex: "1000")
  rcs             String?  // Ville d'immatriculation (ex: "Paris")
  iban            String?
  bic             String?
  penalties       String?  // Taux de pénalités (ex: "3 fois le taux d'intérêt légal")

  // Extended Company Data (Legal/Activity)
  legalForm       String?  // e.g. "Entrepreneur individuel", "SARL"...
  nafCode         String?  // e.g. "53.20Z"
  activityLabel   String?  // e.g. "Autres activités de poste et de courrier"
  managerName     String?  // e.g. "Jean Dupont"
  rcsNumber       String?  // Inscription
  creationDate    DateTime? // Date de création
  category        String?  // PME, ETI...
  
  // External Accountant
  accountantFirmId String? @db.ObjectId
  accountantFirm   AccountantFirm? @relation(fields: [accountantFirmId], references: [id])
  
  // Relations
  users           User[]
  clients         Client[]
  invoices        Invoice[]
  products        Product[]
  templates       InvoiceTemplate[]
  apiKeys         ApiKey[]
  settings        CompanySettings?
  expenses        Expense[]
  bankAccounts    BankAccount[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// --------------------------------------
// ACCOUNTANT FIRM (CABINET D'EXPERTISE)
// --------------------------------------

model AccountantFirm {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  email       String   @unique
  phone       String?
  address     Json?
  logoUrl     String?
  
  users       User[]   // Accountants working in this firm
  companies   Company[] // Client companies managed by this firm
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --------------------------------------
// USERS (WITHIN COMPANIES OR FIRMS)
// --------------------------------------

enum UserRole {
  OWNER
  ADMIN
  ACCOUNTANT // Internal Accountant (CFO)
  SALES
  FIRM_ADMIN // External Accountant Admin
  FIRM_USER  // External Accountant Collaborator
}

model User {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  email       String   @unique
  password    String
  firstName   String
  lastName    String
  role        UserRole @default(ADMIN)
  
  // A user belongs EITHER to a Company OR an AccountantFirm
  companyId   String?  @db.ObjectId
  company     Company? @relation(fields: [companyId], references: [id])
  
  accountantFirmId String? @db.ObjectId
  accountantFirm   AccountantFirm? @relation(fields: [accountantFirmId], references: [id])
  
  tickets     Ticket[] // Support tickets

  createdAt   DateTime @default(now())
}

// --------------------------------------
// SUPPORT SYSTEM
// --------------------------------------

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Ticket {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  subject     String
  status      TicketStatus @default(OPEN)
  priority    TicketPriority @default(MEDIUM)
  
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id])
  
  messages    TicketMessage[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TicketMessage {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  content     String
  isAdmin     Boolean  @default(false) // True if sent by admin
  
  ticketId    String   @db.ObjectId
  ticket      Ticket   @relation(fields: [ticketId], references: [id])
  
  createdAt   DateTime @default(now())
}

// --------------------------------------
// CRM & CATALOG
// --------------------------------------

model Client {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   
  isBusiness  Boolean  @default(true)
  siren       String?
  siret       String?
  legalForm   String?
  nafCode     String?
  vatSystem   String?
  vatNumber   String?
  email       String
  phone       String?
  address     Json     // { billing: {...}, delivery: {...} }
  
  companyId   String   @db.ObjectId
  company     Company  @relation(fields: [companyId], references: [id])
  invoices    Invoice[]
  
  accountingCode String? // Custom aux code (e.g. CLIENT001)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}



model Product {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  price       Float    // Decimal is tricky in Mongo, using Float for simplicity or Int (cents) is often easier. Let's stick to Float/Int or keep Decimal if mapped correctly.
  vatRate     Float
  unit        String   @default("piece") // jour, heure, forfait, etc.
  
  accountingAccount String? // Override default sales account (e.g. 706xxx)
  
  companyId   String   @db.ObjectId
  company     Company  @relation(fields: [companyId], references: [id])
}

// --------------------------------------
// INVOICING CORE (COMPLIANCE CRITICAL)
// --------------------------------------

enum InvoiceStatus {
  DRAFT       // Modifiable
  VALIDATED   // Scellé, envoyé au client (Immutable)
  PARTIALLY_PAID
  PAID
  OVERDUE     // En retard
  CANCELLED   // Annulé
}

enum DocumentType {
  INVOICE
  QUOTE       // Devis
  CREDIT_NOTE // Avoir
}

model Invoice {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  
  // Chrono Sequence (Must be unique per Company + Year)
  seqNumber       Int?           // 1, 2, 3... (Optional for Drafts)
  invoiceNumber   String         @unique // "2026-F001"
  
  type            DocumentType   @default(INVOICE)
  status          InvoiceStatus  @default(DRAFT)
  
  issueDate       DateTime       @default(now())
  dueDate         DateTime?
  validityDate    DateTime?      // Pour les Devis (Valid until)
  validationDate  DateTime?      // Date de validation finale (Factur-X)
  
  // Compliance / Security
  pdfUrl          String?
  securityHash    String?
  previousHash    String?

  // Dunning
  reminderLevel   Int            @default(0)
  lastReminderDate DateTime?
  
  // Financials
  subTotal        Float
  taxAmount       Float
  total           Float
  
  notes           String?
  terms           String?        // Conditions spécifiques
  
  // Relations
  clientId        String         @db.ObjectId
  client          Client         @relation(fields: [clientId], references: [id])
  
  companyId       String         @db.ObjectId
  company         Company        @relation(fields: [companyId], references: [id])
  
  items           InvoiceItem[]
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  @@index([companyId])
  @@index([clientId])
  @@unique([companyId, invoiceNumber])
}

model InvoiceItem {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String
  quantity    Float
  unitPrice   Float
  vatRate     Float
  total       Float
  
  invoiceId   String   @db.ObjectId
  invoice     Invoice  @relation(fields: [invoiceId], references: [id])
}

// --------------------------------------
// INVOICE TEMPLATES & CUSTOMIZATION
// --------------------------------------

enum TemplateType {
  CLASSIC
  MODERN
  ELEGANT
  COLORFUL
}

enum LogoPosition {
  LEFT
  CENTER
  RIGHT
}

enum HeaderStyle {
  MINIMAL
  DETAILED
  BANNER
}

model InvoiceTemplate {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  name        String       // "Mon template bleu", "Template entreprise"
  type        TemplateType @default(CLASSIC)
  isDefault   Boolean      @default(false)
  
  // Customization - Colors
  primaryColor     String @default("#4F46E5")    // Indigo
  secondaryColor   String @default("#818CF8")    // Light Indigo
  textColor        String @default("#1F2937")    // Gray-800
  backgroundColor  String @default("#FFFFFF")    // White
  
  // Logo
  logoUrl          String?
  logoPosition     LogoPosition @default(LEFT)
  logoWidth        Int          @default(150)   // pixels
  
  // Typography
  fontFamily       String @default("Inter")
  headerFontSize   Int    @default(24)
  bodyFontSize     Int    @default(14)
  
  // Layout
  headerStyle      HeaderStyle @default(DETAILED)
  showFooter       Boolean     @default(true)
  footerText       String?
  
  // Legal & Payment
  legalMentions    String?
  paymentTermsText String?
  
  // Relations
  companyId   String  @db.ObjectId
  company     Company @relation(fields: [companyId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([companyId])
}

// Company Settings for Legal Compliance
model CompanySettings {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Legal Information (Required for French invoices)
  legalName   String   // Nom légal complet
  legalForm   String   // SARL, SAS, EURL, EI, etc.
  siret       String   @unique
  vatNumber   String?  // TVA Intracommunautaire
  
  // Address
  address     String
  postalCode  String
  city        String
  country     String   @default("France")
  
  // Contact
  email       String
  phone       String
  website     String?
  
  // Banking (for invoice payment)
  iban        String?
  bic         String?
  bankName    String?
  
  // Legal Details
  capital     Float?   // Capital social
  rcs         String?  // RCS Paris B 123 456 789
  insurance   String?  // Assurance professionnelle
  
  // Professional Details
  nafCode     String?  // Code APE/NAF
  tvaSystem   String?  // FRANCHISE, NORMAL, SIMPLIFIE
  
  // Default Settings
  defaultPaymentTerms String @default("Paiement à 30 jours")
  defaultLegalMention String?
  defaultPenaltyRate  String @default("3 fois le taux d'intérêt légal")

  // Accounting Defaults (FEC)
  defaultSalesAccount     String @default("706000")
  defaultVatAccount       String @default("445710")
  defaultPurchasesAccount String @default("606400")
  
  // Relations
  companyId   String   @unique @db.ObjectId
  company     Company  @relation(fields: [companyId], references: [id])
  

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --------------------------------------
// SYSTEM BROADCASTS
// --------------------------------------

enum BroadcastType {
  INFO
  WARNING
  CRITICAL
  SUCCESS
}

model Broadcast {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  message     String
  type        BroadcastType @default(INFO)
  isActive    Boolean  @default(true)
  expiresAt   DateTime?
  
  createdBy   String?
  
  createdAt   DateTime @default(now())
}

// --------------------------------------
// SYSTEM AUDIT & SECURITY
// --------------------------------------

model AuditLog {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  action      String   // e.g. "UPDATE_COMPANY_PLAN"
  actorId     String   // Admin ID
  targetId    String?  // Company/User ID
  metadata    Json?    // { oldPlan: 'FREE', newPlan: 'PRO' }
  ipAddress   String?
  
  createdAt   DateTime @default(now())
}

model ApiKey {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   // "Make Integration", "Zapier", etc.
  prefix      String   // "sk_live_..." (first few chars for display)
  keyHash     String
  
  lastUsedAt  DateTime?
  
  companyId   String   @db.ObjectId
  company     Company  @relation(fields: [companyId], references: [id])
  
  createdAt   DateTime @default(now())
}

// --------------------------------------
// EXPENSE MANAGEMENT
// --------------------------------------

enum ExpenseStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
}

model Expense {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String
  amount      Float
  currency    String   @default("EUR")
  date        DateTime
  supplier    String
  category    String?  // e.g. "Travel", "Software"
  
  vatAmount   Float?
  proofUrl    String?  // URL to receipt image/pdf
  
  status      ExpenseStatus @default(PENDING)
  
  companyId   String   @db.ObjectId
  company     Company  @relation(fields: [companyId], references: [id])
  
  // OCR Data
  detectedData Json?   // Raw OCR results { text, confidence, entities }
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([companyId])
}

// --------------------------------------
// BANKING & RECONCILIATION
// --------------------------------------

model BankAccount {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   // "Compte Principal", "Livret A"
  iban        String?
  currency    String   @default("EUR")
  bankName    String?
  
  companyId   String   @db.ObjectId
  company     Company  @relation(fields: [companyId], references: [id])
  
  transactions BankTransaction[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model BankTransaction {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  externalId  String?  // ID from bank/import
  date        DateTime
  amount      Float
  label       String
  reference   String?
  category    String?
  
  status      String   @default("PENDING") // PENDING, MATCHED, IGNORED
  
  // Reconciliation Links
  linkedInvoiceId String? @db.ObjectId // Linked to Sales Invoice
  linkedExpenseId String? @db.ObjectId // Linked to Purchase Expense
  
  bankAccountId String   @db.ObjectId
  bankAccount   BankAccount @relation(fields: [bankAccountId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([bankAccountId])
  @@index([date])
}
